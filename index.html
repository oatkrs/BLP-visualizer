<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homework 3 Question 6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #E5E7EB; /* text-gray-200 */
            overflow: hidden; /* Prevent body scroll */
            height: 100vh; /* Ensure body takes full viewport height */
        }
        /* Ensure flex column layout for lanes */
        #viz-container {
             display: flex;
             flex-direction: column;
             gap: 0.5rem; /* space between lanes */
             height: 100%; /* Make container fill its grid space */
        }
        .security-lane {
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            flex: 1; /* Make lanes share height equally */
            min-height: 80px; /* Prevent collapsing */
            padding: 1rem; /* p-4 */
            padding-top: 2rem; /* pt-8 - More space for the label */
            position: relative; /* For label positioning */
            display: flex;
            align-items: center;
            gap: 1rem; /* gap-4 */
            flex-wrap: wrap;
            transition: background-color 0.3s;
        }
        .lane-label {
            position: absolute;
            top: -1px;
            left: -1px;
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            border-top-left-radius: 0.75rem; /* rounded-tl-xl */
            border-bottom-right-radius: 0.75rem; /* rounded-br-xl */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            letter-spacing: 0.05em; /* tracking-wider */
            z-index: 10;
            color: white; /* Ensure text is visible */
        }
        .entity {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem; /* p-2 */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4B5563; /* border-gray-600 */
            min-width: 90px; /* Adjust size */
            text-align: center;
            transition: opacity 0.5s ease-in-out, box-shadow 0.3s;
            opacity: 1;
        }
        .subject {
            background-color: #3B82F6; /* bg-blue-500 */
            border-color: #2563EB; /* border-blue-600 */
            color: white;
        }
        .entity-icon {
            width: 2rem; /* w-8, h-8 */
            height: 2rem;
            margin-bottom: 0.25rem; /* mb-1 */
        }
        .object-icon {
             filter: invert(1); /* Keep file icon white */
        }
        .entity .name { font-weight: 600; font-size: 0.875rem; } /* text-sm */
        .entity .level { font-size: 0.75rem; color: #D1D5DB; } /* text-xs text-gray-300 */
        .entity .current { font-size: 0.75rem; color: #F9FAFB; font-style: italic; } /* text-xs text-gray-50 */

        /* Animations */
        @keyframes flash-success { 0%, 100% { box-shadow: 0 0 0px 0px #22C55E; } 50% { box-shadow: 0 0 8px 3px #22C55E; } } /* green-500 */
        @keyframes flash-fail { 0%, 100% { box-shadow: 0 0 0px 0px #EF4444; } 50% { box-shadow: 0 0 8px 3px #EF4444; } }    /* red-500 */
        @keyframes flash-move { 0%, 100% { box-shadow: 0 0 0px 0px #3B82F6; } 50% { box-shadow: 0 0 8px 3px #3B82F6; } }    /* blue-500 */
        @keyframes flash-add { 0% { opacity: 0; transform: scale(0.8); } 70% { opacity: 1; transform: scale(1.05); box-shadow: 0 0 8px 3px #F59E0B; } 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 0px 0px #F59E0B;} } /* amber-500 */

        .flash-success { animation: flash-success 0.8s ease-in-out; }
        .flash-fail { animation: flash-fail 0.8s ease-in-out; }
        .flash-move { animation: flash-move 0.8s ease-in-out; }
        .flash-add { animation: flash-add 0.8s ease-out; }

        /* Control Panel */
        .control-panel { background-color: #1F2937; border-radius: 0.75rem; padding: 1rem; } /* bg-gray-800 rounded-xl p-4 */
        .panel-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: white; } /* text-base */
        .btn { padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; color: white; border: none; cursor: pointer; transition: background-color 0.2s; } /* text-sm */
        .btn:disabled { background-color: #4B5563; cursor: not-allowed; } /* Style disabled buttons */
        .btn-blue { background-color: #3B82F6; } .btn-blue:hover:not(:disabled) { background-color: #2563EB; }
        .btn-green { background-color: #10B981; } .btn-green:hover:not(:disabled) { background-color: #059669; }
        .btn-red { background-color: #EF4444; } .btn-red:hover:not(:disabled) { background-color: #DC2626; }
        .btn-gray { background-color: #4B5563; } .btn-gray:hover:not(:disabled) { background-color: #6B7280; }
        .btn-case { background-color: #4B5563; margin: 0.125rem; } .btn-case:hover:not(:disabled) { background-color: #6B7280; } /* m-0.5 */
        .btn-custom-case { background-color: #059669; margin: 0.125rem; position: relative; } .btn-custom-case:hover:not(:disabled) { background-color: #047857; }
        .btn-custom-case .delete-case { position: absolute; top: -6px; right: -6px; background: #DC2626; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; line-height: 18px; text-align: center; font-weight: bold; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; border: 1px solid #1F2937;}
        .btn-custom-case .delete-case:hover { opacity: 1; }

        #log-output { background-color: #030712; border: 1px solid #374151; font-family: monospace; font-size: 0.75rem; white-space: pre-wrap; word-wrap: break-word; } /* text-xs */
        .log-system { color: #60A5FA; } /* blue-400 */ .log-allow { color: #34D399; } /* green-400 */ .log-deny { color: #F87171; } /* red-400 */
        .log-action { color: #D1D5DB; } /* gray-300 */ .log-info { color: #A78BFA; } /* violet-400 */ .log-init { color: #FBBF24; } /* amber-400 */

        #code-editor { background-color: #030712; border: 1px solid #374151; color: #E5E7EB; font-family: monospace; font-size: 0.875rem; border-radius: 0.5rem; width: 100%; padding: 0.5rem; resize: vertical; }
        .dropdown { background-color: #374151; border: 1px solid #4B5563; color: white; font-size: 0.875rem; }
        .dropdown:disabled { background-color: #4B5563; color: #9CA3AF; cursor: not-allowed; } /* Style disabled dropdowns */
        input.dropdown:disabled { background-color: #4B5563; color: #9CA3AF; cursor: not-allowed; }

        /* Custom Scrollbar */
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #4B5563 #1F2937; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1F2937; border-radius: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 8px; border: 2px solid #1F2937; } /* Add border for padding */
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6B7280; }
    </style>
</head>
<body class="p-4 h-screen flex flex-col">
    <header class="text-center mb-3">
        <h1 class="text-2xl font-bold text-white">Bell-LaPadula (BLP) Simulator for 6200</h1>
    </header>

    <div class="flex-1 grid grid-cols-3 gap-4 min-h-0">
        <!-- Left Panel: Visualization -->
        <div id="viz-container" class="col-span-2 h-full">
            {/* Visualisation area - content generated by JS */}
        </div>

        <!-- Right Panel: Controls -->
        <div class="col-span-1 h-full flex flex-col gap-3 overflow-y-auto pr-2 custom-scrollbar">
            
            <div class="control-panel">
                <h3 class="panel-title">Default Cases</h3>
                <div id="default-cases-panel" class="flex flex-wrap justify-center"></div>
                <h3 class="panel-title mt-3">My Saved Cases</h3>
                <div id="custom-cases-panel" class="flex flex-wrap justify-center min-h-[30px]"></div>
                <button id="reset-state" class="btn btn-red w-full mt-3">Reset to Initial State</button>
            </div>

            <div class="control-panel">
                <h3 class="panel-title">Playground</h3>
                <div class="grid grid-cols-2 gap-2 mb-2">
                     <select id="playground-subject" class="dropdown p-1.5 rounded-md"></select>
                     <select id="playground-object" class="dropdown p-1.5 rounded-md"></select>
                     <button id="playground-read" class="btn btn-green col-span-1">Read</button>
                     <button id="playground-write" class="btn btn-blue col-span-1">Write</button>
                </div>
                 <div class="grid grid-cols-3 gap-1">
                     <input type="text" id="playground-setlevel-subject" placeholder="Subj ID" class="dropdown p-1.5 rounded-md col-span-1 text-xs">
                     <select id="playground-setlevel-level" class="dropdown p-1.5 rounded-md col-span-1 text-xs">
                         <option value="U">U</option> <option value="C">C</option> <option value="S">S</option> <option value="TS">TS</option>
                     </select>
                     <button id="playground-setlevel" class="btn btn-blue col-span-1 text-xs px-2">Set Level</button>
                </div>
            </div>

            <div class="control-panel">
                <h3 class="panel-title">Code Editor</h3>
                <textarea id="code-editor" rows="7" class="mb-2 custom-scrollbar" placeholder="Edit code or click a case..."></textarea>
                <div class="flex gap-2">
                    <button id="run-code" class="btn btn-green flex-1">Run Code</button>
                    <button id="save-case" class="btn btn-blue flex-1">Save Case</button>
                </div>
            </div>

            <div class="control-panel flex-1 flex flex-col min-h-[150px]">
                <h3 class="panel-title">Log</h3>
                <div id="log-output" class="flex-1 rounded-md p-2 overflow-y-auto custom-scrollbar">
                    <span class="log-system">> System ready.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const SECURITY_LEVELS = { "U": 0, "C": 1, "S": 2, "TS": 3 };
        const VALID_LEVELS = Object.keys(SECURITY_LEVELS);
        const LANE_CONFIG = {
            "TS": { label: "Top Secret", color: "bg-red-900", labelColor: "bg-red-700" },
            "S":  { label: "Secret", color: "bg-purple-900", labelColor: "bg-purple-700" },
            "C":  { label: "Confidential", color: "bg-blue-900", labelColor: "bg-blue-700" },
            "U":  { label: "Unclassified", color: "bg-green-900", labelColor: "bg-green-700" }
        };
        const INITIAL_SETUP_CODE = `# Initial Setup based on PDF
addSubject("alice", "S", "U")
addSubject("bob", "C", "C")
addSubject("eve", "U", "U")
addObject("pub.txt", "U")
addObject("emails.txt", "C")
addObject("username.txt", "S")
addObject("password.txt", "TS")`;

        const DEFAULT_TEST_CASES = [
             { name: "Case #1", code: `read("alice", "emails.txt")`},
             { name: "Case #2", code: `read("alice", "password.txt")`},
             { name: "Case #3", code: `read("eve", "pub.txt")`},
             { name: "Case #4", code: `read("eve", "emails.txt")`},
             { name: "Case #5", code: `read("bob", "password.txt")`},
             { name: "Case #6", code: `read("alice", "emails.txt")\nwrite("alice", "pub.txt")`},
             { name: "Case #7", code: `read("alice", "emails.txt")\nwrite("alice", "password.txt")`},
             { name: "Case #8", code: `read("alice", "emails.txt")\nwrite("alice", "emails.txt")\nread("alice", "username.txt")\nwrite("alice", "emails.txt")`},
             { name: "Case #9", code: `read("alice", "emails.txt")\nwrite("alice", "username.txt")\nread("alice", "password.txt")\nwrite("alice", "emails.txt")`},
             { name: "Case #10", code: `read("alice", "pub.txt")\nwrite("alice", "emails.txt")\nread("bob", "emails.txt")`},
             { name: "Case #11", code: `read("alice", "pub.txt")\nwrite("alice", "username.txt")\nread("bob", "username.txt")`},
             { name: "Case #12", code: `read("alice", "pub.txt")\nwrite("alice", "password.txt")\nread("bob", "password.txt")`},
             { name: "Case #13", code: `read("alice", "pub.txt")\nwrite("alice", "emails.txt")\nread("eve", "emails.txt")`},
             { name: "Case #14", code: `read("alice", "emails.txt")\nwrite("alice", "pub.txt")\nread("eve", "pub.txt")`},
             { name: "Case #15", code: `setLevel("alice", "S")\nread("alice", "username.txt")`},
             { name: "Case #16", code: `read("alice", "emails.txt")\nsetLevel("alice", "U")\nwrite("alice", "pub.txt")\nread("eve", "pub.txt")`},
             { name: "Case #17", code: `read("alice", "username.txt")\nsetLevel("alice", "C")\nwrite("alice", "emails.txt")\nread("eve", "emails.txt")`},
             { name: "Optional Case", code: `// Side-Channel Demo\nread("eve", "pub.txt")\nread("eve", "emails.txt")`},
        ];

        // --- Global State ---
        let state = { subjects: {}, objects: {} };
        let customCases = [];
        let executionTimeout = null; // To manage sequential execution
        let isExecuting = false; // Flag to prevent overlaps

        // --- DOM Elements ---
        const vizContainer = document.getElementById('viz-container');
        const logOutput = document.getElementById('log-output');
        const editor = document.getElementById('code-editor');
        const defaultCasesPanel = document.getElementById('default-cases-panel');
        const customCasesPanel = document.getElementById('custom-cases-panel');
        const playgroundSubjectSelect = document.getElementById('playground-subject');
        const playgroundObjectSelect = document.getElementById('playground-object');
        const playgroundSetLevelSubjectInput = document.getElementById('playground-setlevel-subject');
        const runCodeButton = document.getElementById('run-code');
        const resetButton = document.getElementById('reset-state');
        const saveCaseButton = document.getElementById('save-case');
        const playgroundReadButton = document.getElementById('playground-read');
        const playgroundWriteButton = document.getElementById('playground-write');
        const playgroundSetLevelButton = document.getElementById('playground-setlevel');

        // --- Local Storage ---
        function loadCustomCases() {
            const saved = localStorage.getItem('blpCustomCases_v4'); // Incremented version
            customCases = saved ? JSON.parse(saved) : [];
        }
        function saveCustomCases() {
            localStorage.setItem('blpCustomCases_v4', JSON.stringify(customCases));
        }

        // --- Logging ---
        function logMessage(message, type = 'log-action') {
            const line = document.createElement('div');
            line.textContent = message;
            line.className = type;
            logOutput.appendChild(line);
            logOutput.scrollTop = logOutput.scrollHeight; // Auto-scroll
        }
        function clearLog() { logOutput.innerHTML = ''; }

        // --- BLP Model (Core Logic Functions) ---
        const BLP_MODEL = {
             _validateLevel: (level, context = '') => {
                 if (!VALID_LEVELS.includes(level)) {
                     logMessage(`> DENY: Invalid level "${level}" ${context}. Use U, C, S, or TS.`, 'log-deny');
                     return false;
                 } return true;
             },
             addSubject: (pid, max_level, start_level) => {
                 logMessage(`> Init: Add Subject "${pid}" (Max: ${max_level}, Start: ${start_level})`, 'log-init');
                 if (state.subjects[pid]) return logMessage(`> FAIL: Subject "${pid}" already exists.`, 'log-deny'), false;
                 if (!BLP_MODEL._validateLevel(max_level, `for max_level of ${pid}`)) return false;
                 if (!BLP_MODEL._validateLevel(start_level, `for start_level of ${pid}`)) return false;
                 if (SECURITY_LEVELS[start_level] > SECURITY_LEVELS[max_level]) return logMessage(`> FAIL: Start level ${start_level} > Max level ${max_level} for ${pid}.`, 'log-deny'), false;
                 state.subjects[pid] = { name: pid.charAt(0).toUpperCase() + pid.slice(1), max_level, current_level: start_level };
                 return true; // Success - state changed
             },
             addObject: (oid, level) => {
                  logMessage(`> Init: Add Object "${oid}" (Level: ${level})`, 'log-init');
                 if (state.objects[oid]) return logMessage(`> FAIL: Object "${oid}" already exists.`, 'log-deny'), false;
                 if (!BLP_MODEL._validateLevel(level, `for level of ${oid}`)) return false;
                 state.objects[oid] = { name: oid, level };
                 return true; // Success - state changed
             },
             read: (pid, oid) => {
                 const subject = state.subjects[pid]; const object = state.objects[oid];
                 if (!subject) return logMessage(`> FAIL: Subject "${pid}" not found.`, 'log-deny'), false;
                 if (!object) return logMessage(`> FAIL: Object "${oid}" not found.`, 'log-deny'), false;

                 const subj_curr_num = SECURITY_LEVELS[subject.current_level]; const subj_max_num = SECURITY_LEVELS[subject.max_level]; const obj_lvl_num = SECURITY_LEVELS[object.level];
                 logMessage(`> Action: ${subject.name} READ ${object.name}...`, 'log-action');

                 if (obj_lvl_num <= subj_curr_num) { logMessage(`> ALLOW: Obj Lvl (${object.level}) <= Subj Curr (${subject.current_level}).`, 'log-allow'); flashEntity(pid); flashEntity(oid); return false; } // Success - state NOT changed
                 if (obj_lvl_num <= subj_max_num) { logMessage(`> ALLOW: Obj Lvl (${object.level}) <= Subj Max (${subject.max_level}).`, 'log-allow'); logMessage(`> INFO: Raising ${subject.name}'s current level to ${object.level}.`, 'log-info'); subject.current_level = object.level; flashEntity(pid, 'flash-move'); flashEntity(oid); return true; } // Success - state changed
                 logMessage(`> DENY: No Read Up! Obj Lvl (${object.level}) > Subj Max (${subject.max_level}).`, 'log-deny'); flashEntity(pid, 'flash-fail'); flashEntity(oid, 'flash-fail'); return false;
             },
             write: (pid, oid) => {
                  const subject = state.subjects[pid]; const object = state.objects[oid];
                 if (!subject) return logMessage(`> FAIL: Subject "${pid}" not found.`, 'log-deny'), false;
                 if (!object) return logMessage(`> FAIL: Object "${oid}" not found.`, 'log-deny'), false;

                 const subj_curr_num = SECURITY_LEVELS[subject.current_level]; const obj_lvl_num = SECURITY_LEVELS[object.level];
                 logMessage(`> Action: ${subject.name} WRITE ${object.name}...`, 'log-action');

                 if (subj_curr_num <= obj_lvl_num) { logMessage(`> ALLOW: Subj Curr (${subject.current_level}) <= Obj Lvl (${object.level}).`, 'log-allow'); flashEntity(pid); flashEntity(oid); return false; } // Success - state NOT changed
                 logMessage(`> DENY: No Write Down! Subj Curr (${subject.current_level}) > Obj Lvl (${object.level}).`, 'log-deny'); flashEntity(pid, 'flash-fail'); flashEntity(oid, 'flash-fail'); return false;
             },
             setLevel: (pid, new_level) => {
                  const subject = state.subjects[pid];
                 if (!subject) return logMessage(`> FAIL: Subject "${pid}" not found.`, 'log-deny'), false;
                 if (!BLP_MODEL._validateLevel(new_level, `for ${pid}'s new level`)) return false;

                 const subj_curr_num = SECURITY_LEVELS[subject.current_level]; const subj_max_num = SECURITY_LEVELS[subject.max_level]; const new_lvl_num = SECURITY_LEVELS[new_level];
                 logMessage(`> Action: ${subject.name} SET LEVEL to ${new_level}...`, 'log-action');

                 if (new_lvl_num < subj_curr_num) { logMessage(`> DENY: Cannot lower level from ${subject.current_level} to ${new_level}.`, 'log-deny'); flashEntity(pid, 'flash-fail'); return false; }
                 if (new_lvl_num > subj_max_num) { logMessage(`> DENY: New level ${new_level} exceeds max level ${subject.max_level}.`, 'log-deny'); flashEntity(pid, 'flash-fail'); return false; }
                 if (new_lvl_num === subj_curr_num) { logMessage(`> INFO: Level already ${new_level}. No change.`, 'log-info'); flashEntity(pid); return false; } // Success - state NOT changed
                 logMessage(`> ALLOW: Level changed to ${new_level}.`, 'log-allow'); subject.current_level = new_level; flashEntity(pid, 'flash-move'); return true; // Success - state changed
            }
        };

        // --- Rendering ---
        function renderState() {
             vizContainer.innerHTML = ''; // Clear old elements
             const levelOrder = ['TS', 'S', 'C', 'U'];
             const lanes = {};

             levelOrder.forEach(level => { // Create lanes
                 const config = LANE_CONFIG[level];
                 const lane = document.createElement('div');
                 lane.id = `lane-${level}`;
                 lane.className = `security-lane ${config.color}`;
                 const label = document.createElement('span');
                 label.className = `lane-label ${config.labelColor}`;
                 label.textContent = config.label;
                 lane.appendChild(label);
                 vizContainer.appendChild(lane);
                 lanes[level] = lane;
             });

             // Add entities to correct lanes - crucial to check state exists
             Object.entries(state.subjects || {}).forEach(([id, subject]) => {
                if(lanes[subject.current_level]) lanes[subject.current_level].appendChild(createSubjectElement(id, subject));
                 else console.error(`Render Error: Could not find lane for subject ${id} level ${subject.current_level}`);
             });
              Object.entries(state.objects || {}).forEach(([id, object]) => {
                if(lanes[object.level]) lanes[object.level].appendChild(createObjectElement(id, object));
                 else console.error(`Render Error: Could not find lane for object ${id} level ${object.level}`);
             });
        }

        function createSubjectElement(id, subject) {
             const el = document.createElement('div'); el.id = `entity-${id}`; el.className = 'entity subject';
             const imgSrc = `${id}.svg`; // Assumes files are in root
             // Added placeholder SVG in onerror
             el.innerHTML = `<img class="entity-icon" src="${imgSrc}" alt="${subject.name}" onerror="this.alt='?'; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 10 10%22%3E%3Ctext x=%225%22 y=%228%22 font-size=%228%22 text-anchor=%22middle%22 fill=%22white%22%3E?%3C/text%3E%3C/svg%3E';">
                            <span class="name">${subject.name}</span><span class="level">(Max:${subject.max_level})</span><span class="current">Curr:${subject.current_level}</span>`;
             return el;
        }
        function createObjectElement(id, object) {
             const el = document.createElement('div'); el.id = `entity-${id}`; el.className = 'entity';
             el.innerHTML = `<svg class="entity-icon object-icon" viewBox="0 0 384 512" fill="currentColor"><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 119L239 0V128h145z"/></svg>
                            <span class="name">${object.name}</span><span class="level">Lvl:${object.level}</span>`;
             return el;
        }
        function flashEntity(id, type = 'flash-success') {
            const el = document.getElementById(`entity-${id}`);
            if (!el) return;
            const classes = ['flash-success', 'flash-fail', 'flash-move', 'flash-add'];
            el.classList.remove(...classes);
            void el.offsetWidth; // Reflow trick
            el.classList.add(type);
            el.addEventListener('animationend', () => el.classList.remove(type), { once: true });
        }

        // --- UI Updates ---
        function renderDefaultCaseButtons() {
            defaultCasesPanel.innerHTML = '';
            DEFAULT_TEST_CASES.forEach(tc => {
                const btn = document.createElement('button'); btn.className = 'btn btn-case'; btn.textContent = tc.name;
                btn.onclick = () => loadTestCaseToEditor(tc);
                defaultCasesPanel.appendChild(btn);
            });
        }
        function renderCustomCaseButtons() {
             customCasesPanel.innerHTML = '';
             if (customCases.length === 0) customCasesPanel.innerHTML = `<span class="text-xs text-gray-500 italic">No saved cases.</span>`;
             customCases.forEach((tc, index) => {
                 const btn = document.createElement('button'); btn.className = 'btn btn-custom-case'; btn.textContent = tc.name;
                 btn.onclick = () => loadCustomCodeToEditor(tc.code, tc.name);
                 const del = document.createElement('span'); del.className = 'delete-case'; del.innerHTML = '&times;'; del.title = `Delete "${tc.name}"`;
                 del.onclick = (e) => { e.stopPropagation(); deleteCustomCase(index, tc.name); };
                 btn.appendChild(del); customCasesPanel.appendChild(btn);
             });
        }
        function updatePlaygroundDropdowns() {
             playgroundSubjectSelect.innerHTML = ''; playgroundObjectSelect.innerHTML = '';
             const subjectIds = Object.keys(state.subjects || {}).sort(); const objectIds = Object.keys(state.objects || {}).sort();
             if (subjectIds.length === 0) playgroundSubjectSelect.add(new Option("No Subjects", ""));
             else subjectIds.forEach(id => playgroundSubjectSelect.add(new Option(state.subjects[id].name, id)));
             if (objectIds.length === 0) playgroundObjectSelect.add(new Option("No Objects", ""));
             else objectIds.forEach(id => playgroundObjectSelect.add(new Option(state.objects[id].name, id)));
             playgroundSubjectSelect.disabled = subjectIds.length === 0; playgroundObjectSelect.disabled = objectIds.length === 0;
             playgroundSetLevelSubjectInput.placeholder = subjectIds.length === 0 ? "No Subj" : "Subj ID";
        }

        function setControlsDisabled(disabled) {
            isExecuting = disabled;
            [runCodeButton, resetButton, saveCaseButton, playgroundReadButton, playgroundWriteButton, playgroundSetLevelButton].forEach(btn => btn.disabled = disabled);
            [playgroundSubjectSelect, playgroundObjectSelect, playgroundSetLevelSubjectInput, editor].forEach(el => el.disabled = disabled);
            defaultCasesPanel.querySelectorAll('button').forEach(btn => btn.disabled = disabled);
            customCasesPanel.querySelectorAll('button').forEach(btn => btn.disabled = disabled);
        }

        // --- Actions ---
        function resetToInitialState() {
             if (isExecuting) return; // Prevent reset during execution
             clearTimeout(executionTimeout); // Stop any ongoing execution
             state = { subjects: {}, objects: {} }; // Clear state first
             clearLog(); logMessage('> Resetting to initial state...', 'log-system');
             editor.value = INITIAL_SETUP_CODE; // Put setup code in editor
             const setupActions = parseCode(INITIAL_SETUP_CODE);
             // Execute setup SYNCHRONOUSLY but call BLP methods
             setupActions.forEach(action => {
                  const command = action[0]; const args = action.slice(1);
                  if (BLP_MODEL[command]) BLP_MODEL[command](...args);
             });
             renderState(); // Render the final initial state
             updatePlaygroundDropdowns();
             logMessage('> Initial state ready.', 'log-system');
        }

        function loadTestCaseToEditor(testCase) {
             if (isExecuting) return;
             clearTimeout(executionTimeout);
             editor.value = INITIAL_SETUP_CODE + `\n\n# --- ${testCase.name} ---\n` + testCase.code;
             logMessage(`> Loaded ${testCase.name}. Click 'Run Code'.`, 'log-system');
             editor.focus();
        }
         function loadCustomCodeToEditor(code, name) {
              if (isExecuting) return;
              clearTimeout(executionTimeout);
              editor.value = code; // Custom cases likely include their own setup
              logMessage(`> Loaded custom case "${name}". Click 'Run Code'.`, 'log-system');
              editor.focus();
         }

        function runCodeFromEditor() {
            if (isExecuting) return;
            clearTimeout(executionTimeout);
            const code = editor.value.trim();
            if (!code) return logMessage("> Editor is empty.", 'log-deny');
            state = { subjects: {}, objects: {} }; // Start fresh
            clearLog(); logMessage(`> --- Running Code ---`, 'log-system');
            const actions = parseCode(code);
            if (actions.length > 0) {
                 setControlsDisabled(true); // Disable controls during execution
                 executeActionsSequentially(actions, 0);
            }
            else { logMessage("> No valid actions found.", 'log-deny'); renderState(); updatePlaygroundDropdowns(); }
        }

        function parseCode(code) {
             const actions = []; const lines = code.split('\n');
             const addSubRegex = /addSubject\("([^"]+)"\s*,\s*"([^"]+)"\s*,\s*"([^"]+)"\)/;
             const addObjRegex = /addObject\("([^"]+)"\s*,\s*"([^"]+)"\)/;
             const readWriteRegex = /(read|write)\("([^"]+)"\s*,\s*"([^"]+)"\)/;
             const setLevelRegex = /setLevel\("([^"]+)"\s*,\s*"([^"]+)"\)/;
             lines.forEach(line => {
                 const tl = line.trim(); if (tl.startsWith('#') || tl === '') return;
                 let m;
                 if (m = tl.match(addSubRegex)) actions.push(['addSubject', m[1], m[2], m[3]]);
                 else if (m = tl.match(addObjRegex)) actions.push(['addObject', m[1], m[2]]);
                 else if (m = tl.match(readWriteRegex)) actions.push([m[1], m[2], m[3]]);
                 else if (m = tl.match(setLevelRegex)) actions.push(['setLevel', m[1], m[2]]);
                 else logMessage(`> Syntax Error: "${tl}"`, 'log-deny');
             }); return actions;
        }

        function executeActionsSequentially(actions, index) {
             if (index >= actions.length) {
                 logMessage('> --- Execution Complete ---', 'log-system');
                 renderState(); updatePlaygroundDropdowns(); // Final render/update
                 setControlsDisabled(false); // Re-enable controls
                 return;
             }
             const action = actions[index]; const command = action[0]; const args = action.slice(1);
             let stateChanged = false;
             try {
                 if (BLP_MODEL[command]) {
                      stateChanged = BLP_MODEL[command](...args); // Execute, returns true if state visually changed
                 } else logMessage(`> Error: Unknown command "${command}"`, 'log-deny');
             } catch (e) { logMessage(`> Runtime Error: ${e.message}`, 'log-deny'); console.error(e); }

             if (stateChanged) renderState(); // Re-render immediately if state changed

             // Schedule next action
             executionTimeout = setTimeout(() => executeActionsSequentially(actions, index + 1), 600); // Delay
        }

        function saveCurrentCase() {
             if (isExecuting) return;
             const code = editor.value.trim();
             if (!code) return logMessage("> Editor empty, nothing to save.", 'log-info');
             const name = prompt("Enter name for this case:", "My Case " + (customCases.length + 1));
             if (!name || !name.trim()) return logMessage("> Save cancelled.", 'log-info');
             // Check if name already exists
             if (customCases.some(c => c.name === name.trim())) {
                 alert(`A case named "${name.trim()}" already exists. Please choose a different name.`);
                 return saveCurrentCase(); // Ask again
             }
             customCases.push({ name: name.trim(), code });
             saveCustomCases(); renderCustomCaseButtons();
             logMessage(`> Saved case "${name}".`, 'log-system');
        }
        function deleteCustomCase(index, name) {
             if (isExecuting) return;
             if (confirm(`Delete saved case "${name}"?`)) {
                 customCases.splice(index, 1);
                 saveCustomCases(); renderCustomCaseButtons();
                 logMessage(`> Deleted case "${name}".`, 'log-system');
             }
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
             loadCustomCases();
             renderDefaultCaseButtons();
             renderCustomCaseButtons();
             resetToInitialState(); // Load initial state on page load

             // Bind buttons
             document.getElementById('reset-state').onclick = resetToInitialState;
             document.getElementById('run-code').onclick = runCodeFromEditor;
             document.getElementById('save-case').onclick = saveCurrentCase;

             // Bind playground actions
             playgroundReadButton.onclick = () => {
                 if(isExecuting) return;
                 const subj = playgroundSubjectSelect.value; const obj = playgroundObjectSelect.value;
                 if (subj && obj) { setControlsDisabled(true); executeActionsSequentially([['read', subj, obj]], 0); }
                 else logMessage("> Select subject and object.", 'log-info');
             };
             playgroundWriteButton.onclick = () => {
                 if(isExecuting) return;
                 const subj = playgroundSubjectSelect.value; const obj = playgroundObjectSelect.value;
                 if (subj && obj) { setControlsDisabled(true); executeActionsSequentially([['write', subj, obj]], 0); }
                 else logMessage("> Select subject and object.", 'log-info');
             };
             playgroundSetLevelButton.onclick = () => {
                 if(isExecuting) return;
                 const subj = playgroundSetLevelSubjectInput.value.trim(); const lvl = document.getElementById('playground-setlevel-level').value;
                 if (subj && lvl) { setControlsDisabled(true); executeActionsSequentially([['setLevel', subj, lvl]], 0); }
                 else logMessage("> Enter Subject ID and select level.", 'log-info');
             };
        });
    </script>
</body>
</html>

